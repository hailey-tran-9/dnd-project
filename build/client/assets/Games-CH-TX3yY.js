import{t as e,A as ie,g as le,a as o,w as ce}from"./chunk-ZYFC6VSF-YzFXoqaq.js";import{u as Z,a as Y}from"./react-redux-CX7JyCt4.js";import{g as _}from"./index-35c79a8a-DCN24IeX.js";import"./index.esm2017-l84fuskm.js";import{g as ee,q as K,s as oe,a as W,r as G,b as V,c as me,u as R,i as $}from"./index.esm2017-CGYb_oOY.js";import{B as y}from"./Button-B_obNlYv.js";import{S as de,I as ue}from"./Selection-DlJj9KFW.js";import{I as fe}from"./Input-BmhOrzRe.js";import{d as se,f as X,g as xe,h as he,i as ge}from"./util-BtYTE4DC.js";import{t as B}from"./Toasts--U34NDwv.js";import{v as te}from"./v4-C6aID195.js";import"./toasts-slice-CJ4y-2PB.js";import"./redux-toolkit.modern-gsldsko2.js";function pe({player:c}){return e.jsxs("div",{className:"flex flex-row gap-8 items-center",children:[e.jsx("div",{className:"w-25 h-25 bg-white rounded-md"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("p",{children:c[1]}),e.jsx("p",{children:"Class | Lvl"})]})]})}function ve({cancelFn:c,submitFn:r}){return e.jsxs(ie,{onSubmit:r,children:[e.jsxs("div",{className:"flex flex-row justify-between items-center flex-wrap gap-y-3 mb-10",children:[e.jsx("h1",{children:"Game Creation"}),e.jsx(y,{type:"button",onClick:c,children:"Cancel"})]}),e.jsxs("div",{className:"flex flex-col gap-10",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"game-name",className:"text-black text-[2.5rem] font-[500] mr-10",children:"Game name"}),e.jsx(fe,{id:"game-name",name:"game-name",type:"text",className:"text-[2rem]",required:!0})]}),e.jsx("p",{children:"Map Selection is under construction."})]}),e.jsx(y,{type:"submit",className:"mt-15 float-right",children:"Submit"})]})}var q,z;function je(){if(z)return q;z=1;var c=1e3,r=c*60,i=r*60,n=i*24,m=n*7,d=n*365.25;q=function(s,t){t=t||{};var l=typeof s;if(l==="string"&&s.length>0)return f(s);if(l==="number"&&isFinite(s))return t.long?E(s):h(s);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(s))};function f(s){if(s=String(s),!(s.length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(s);if(t){var l=parseFloat(t[1]),b=(t[2]||"ms").toLowerCase();switch(b){case"years":case"year":case"yrs":case"yr":case"y":return l*d;case"weeks":case"week":case"w":return l*m;case"days":case"day":case"d":return l*n;case"hours":case"hour":case"hrs":case"hr":case"h":return l*i;case"minutes":case"minute":case"mins":case"min":case"m":return l*r;case"seconds":case"second":case"secs":case"sec":case"s":return l*c;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return l;default:return}}}}function h(s){var t=Math.abs(s);return t>=n?Math.round(s/n)+"d":t>=i?Math.round(s/i)+"h":t>=r?Math.round(s/r)+"m":t>=c?Math.round(s/c)+"s":s+"ms"}function E(s){var t=Math.abs(s);return t>=n?w(s,t,n,"day"):t>=i?w(s,t,i,"hour"):t>=r?w(s,t,r,"minute"):t>=c?w(s,t,c,"second"):s+" ms"}function w(s,t,l,b){var k=t>=l*1.5;return Math.round(s/l)+" "+b+(k?"s":"")}return q}var ye=je();const be=le(ye),we=c=>{const[r,i]=o.useState(c),[n,m]=o.useState(!0);return o.useEffect(()=>{let d;return n&&(d=setInterval(()=>{i(f=>f<1e3?(m(!1),0):f-1e3)},1e3)),()=>clearInterval(d)},[n]),{time:r}};function Ie({gameID:c,refreshFn:r,invData:i,invIndex:n,...m}){const d=Z(),{time:f}=we(i.exp-Date.now());o.useEffect(()=>{f<=0&&(console.log("INVITE HAS EXPIRED"),r(`gameInvites/${c}/invites`))},[f]);const h={year:"numeric",month:"short",day:"numeric"};return e.jsxs(o.Fragment,{...m,children:[e.jsxs("p",{onClick:()=>{se(i.inviteLink),d(B("Success","Invite link copied to clipboard."))},className:"text-sky-300 hover:text-sky-200 select-none",children:["Invite ",n+1]}),e.jsx("p",{className:"truncate",children:f>=1e3?be(f):"1s"}),e.jsx("p",{className:"truncate",children:new Date(i.createdOn).toLocaleDateString(void 0,h)})]})}const Ne=e.jsx("p",{className:"col-span-full text-center",children:"There aren't any active invites."});function Ge({htmlRef:c,userID:r,gameID:i,gameName:n}){_();const m=ee(),d=Z(),[f,h]=o.useState(!0),[E,w]=o.useState(null),s=window.crypto.subtle||window.crypto.webkitSubtle;o.useEffect(()=>{t(`gameInvites/${i}/invites`)},[]);function t(g){console.log("QUERY GAME INVITES");const j=K(G(m,g),W("exp"),oe(Date.now()));V(j).then(p=>{const v=p.val();v?(h(!1),w(Object.entries(v).map(([C,N],u)=>e.jsx(Ie,{gameID:i,refreshFn:t,invData:N,invIndex:u},C)))):h(!0)})}function l(g){return s.importKey("jwk",g,{name:"ECDSA",namedCurve:"P-256"},!0,["sign"])}function b(g,j,p){const v={alg:"ES256",typ:"JWT"},C={sub:"game-invite",exp:j,gameID:p,gameName:n,iss:r,jti:g},N=X(JSON.stringify(v)),u=X(JSON.stringify(C)),S=`${N}.${u}`;return V(G(m,`users/users/${r}/private/key`)).then(I=>{I.exists()&&l(I.val()).then(T=>{s.sign({name:"ECDSA",hash:"SHA-256"},T,xe(S)).then(P=>{const F=he(ge(P)),L=`${S}.${F}`,D="/dnd-project/games/invite/"+p+"?token="+L;se(D);const O=`gameInvites/${p}/invites`;R(G(m),{[`${O}/${g}/inviteLink`]:D}).then(()=>{t(O),d(B("Success","Game invite was created! Invite link copied to clipboard."))})})})}),null}function k(g){const j=te(),p=Math.floor(Date.now()+3e5),v=`gameInvites/${g}`,C=K(G(m,v+"/invites"),W("exp"),me(Date.now()));V(C).then(N=>{const u=N.val();if(console.log("games that haven't expired yet:",u),u)if(Object.keys(u).length>=4)d(B("Error","Invite max has been reached. Try again later."));else{const I=Date.now();R(G(m),{[v+"/invites"]:{...u,[j]:{createdOn:I,exp:p}},[v+"/numberOfGameInvites"]:$(1)}).then(()=>{b(j,p,g)})}else{const S=Date.now();R(G(m),{[v+"/invites"]:{[j]:{createdOn:S,exp:p}},[v+"/numberOfGameInvites"]:1}).then(()=>{b(j,p,g)})}})}return e.jsxs("div",{ref:c,className:"hidden bg-white px-7 py-5 rounded-md overflow-hidden",children:[e.jsxs("div",{className:"flex flex-row justify-between items-center",children:[e.jsx("h3",{className:"align-middle",children:"Active Invites"}),e.jsx("button",{onClick:()=>k(i),className:"text-[2rem] text-gray-300 hover:text-gray-700 align-middle",children:"+"})]}),e.jsx("hr",{className:"my-3"}),e.jsxs("div",{className:"flex-none grid grid-cols-3 gap-x-5 gap-y-1 text-[1.25rem] text-start text-clip",children:[e.jsx("p",{className:"text-nowrap text-clip mb-1",children:"Link"}),e.jsx("p",{className:"text-nowrap text-clip mb-1",children:"Expires In"}),e.jsx("p",{className:"text-nowrap text-clip mb-1",children:"Created On"}),f?Ne:E]})]})}const Le=ce(function(){const[r,i]=o.useState(!1),[n,m]=o.useState(),[d,f]=o.useState(!1),h=o.useRef(null),[E,w]=o.useState(!0),s=o.useRef(null),[t,l]=o.useState(!0),b=o.useRef(null),[k,g]=o.useState(!1),j=Y(a=>a.games.games),p=Y(a=>a.games.joinedGames),v=ee(),N=_().currentUser;let u=null;N&&(u=N.uid);function S(){r||i(!0)}function I(){i(!1)}function T(a){r&&I(),n!==a&&m(a)}function P(a){a.target.localName!=="button"&&(r&&I(),m(void 0))}function F(){h.current.ariaExpanded==="false"?(h.current.style.display="block",h.current.ariaExpanded="true",w(!0)):(h.current.style.display="none",h.current.ariaExpanded="false",w(!1))}function L(){s.current.ariaExpanded==="false"?(s.current.style.display="block",s.current.ariaExpanded="true",l(!0)):(s.current.style.display="none",s.current.ariaExpanded="false",l(!1))}function D(){k?(b.current.style.display="none",g(!1)):(b.current.style.display="block",g(!0))}function O(){d?(k&&D(),f(!1)):f(!0)}function ne(a){O();const x="users/users/"+u+"/private";R(G(v),{["games/games/"+a]:null,"games/numberOfGames":$(-1),[x+"/games/gameIDs/"+a]:null,[x+"/games/numberOfGames"]:$(-1),[`gameInvites/${a}`]:null}).then(()=>{}).catch(J=>{console.log("error deleting game"),console.log(J.message)}),m(void 0)}function ae(a){a.preventDefault();const x=new FormData(a.target),J=Object.fromEntries(x),A={charactersInGame:[],gameID:te(),mapsInGame:[],name:J["game-name"],sessions:[],userID:u},Q="users/users/"+u+"/private";R(G(v),{[`games/games/${A.gameID}`]:A,"games/numberOfGames":$(1),[`gameInvites/${A.gameID}`]:{invites:{},numberOfGameInvites:0},[`${Q}/games/gameIDs/${A.gameID}`]:A.name,[`${Q}/games/numberOfGames`]:$(1)}).then(()=>{}).catch(re=>{console.log("error writing the new game into the db"),console.log(re.message)}),I()}let M;r?M=e.jsx(ve,{cancelFn:I,submitFn:ae}):n==null?M=e.jsxs("div",{className:"h-[75vh] text-center content-center",children:[e.jsx("h2",{children:"A game hasn't been selected yet."}),e.jsx("p",{children:"Select a game or create a new one!"})]}):M=e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-row justify-between items-center flex-wrap gap-y-3",children:[e.jsx("h1",{children:n.name}),e.jsxs("div",{className:"flex flex-row gap-5",children:[n.userID===u&&e.jsx(y,{onClick:O,children:d?"Cancel":"Edit"}),d&&e.jsx(y,{onClick:()=>ne(n.gameID),children:"Delete Game"}),!d&&e.jsx(y,{disabled:!0,children:"Enter Game"})]})]}),e.jsxs("div",{className:"flex flex-row gap-x-[5vw] xl:gap-x-[7vw]",children:[e.jsxs("div",{className:"flex flex-col gap-10",children:[e.jsxs("div",{className:"w-[35vw] flex flex-col gap-3",children:[e.jsxs("div",{className:"flex flex-row gap-5 items-center",children:[e.jsx("h2",{children:"Players"}),d&&e.jsx(y,{className:"mb-2",onClick:D,children:"Invites"})]}),e.jsx(Ge,{htmlRef:b,userID:u,gameID:n.gameID,gameName:n.name})]}),e.jsx("ul",{className:"flex flex-col gap-10",children:n.playersInGame?Object.entries(n.playersInGame).map((a,x)=>e.jsx(pe,{player:a},`${n.gameID}-player-component-${x}`)):e.jsx("p",{children:"There are no players in this game."})})]}),e.jsxs("div",{className:"grow flex flex-col gap-10",children:[e.jsx("h2",{children:"Sessions"}),e.jsx("ul",{className:"flex flex-col gap-5",children:e.jsx("li",{children:e.jsx("div",{className:"w-full bg-gray-400 p-10 rounded-sm text-gray-50",children:"Under construction"})})})]})]})]});let U=Object.keys(j).length!==0,H=Object.keys(p).length!==0;return e.jsxs("section",{id:"user-games",className:"flex flex-row grow",children:[e.jsxs(de,{onClick:a=>P(a),children:[e.jsx(y,{onClick:S,children:"+ Create Game"}),e.jsxs("div",{className:"w-full flex flex-col items-start mt-10",children:[e.jsxs("div",{className:"w-full flex flex-row items-center",children:[e.jsx("p",{className:"shrink mr-2",children:"My Games"}),e.jsx("div",{className:"grow border-t border-white"}),U&&e.jsx(y,{onClick:F,padding:"p-0 px-2",className:"border border-white/30","aria-expanded":"true","aria-controls":"my-games",children:E?"-":"+"})]}),U?e.jsx("menu",{id:"my-games",ref:h,className:"w-full flex flex-col mt-3",children:Object.entries(j).map(([a,x])=>e.jsx("li",{children:e.jsx(y,{onClick:()=>T(x),className:"w-full text-start text-[1.3rem]",children:x.name})},x.name))}):e.jsx("p",{className:"text-[1rem] text-gray-200",children:"You haven't created any games."})]}),e.jsxs("div",{className:"w-full flex flex-col items-start mt-10",children:[e.jsxs("div",{className:"w-full flex flex-row items-center",children:[e.jsx("p",{className:"shrink mr-2",children:"Joined Games"}),e.jsx("div",{className:"grow border-t border-white"}),H&&e.jsx(y,{onClick:L,padding:"p-0 px-2",className:"border border-white/30","aria-expanded":"true","aria-controls":"joined-games",children:t?"-":"+"})]}),H?e.jsx("menu",{id:"joined-games",ref:s,className:"w-full flex flex-col mt-3",children:Object.entries(p).map(([a,x])=>e.jsx("li",{children:e.jsx(y,{onClick:()=>T(x),className:"w-full text-start text-[1.3rem]",children:x.name})},x.name))}):e.jsx("p",{className:"text-[1rem] text-gray-200",children:"You haven't joined any games."})]})]}),e.jsx(ue,{children:M})]})});async function Je(){return{title:"Games"}}export{Je as clientLoader,Le as default};
