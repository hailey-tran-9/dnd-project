import{j as T,B,u as G,g as L}from"./util-BYEQYhcI.js";import{v as R,A as O,y as Y,C as F,a as o,t as e,z as U}from"./chunk-ZYFC6VSF-CcTFIW6Y.js";import{g as H,b,r as u,u as J,p as K,d as z,i as M}from"./index.esm2017-BgJZ7Iac.js";import{g as V,o as W}from"./index-35c79a8a-B373Vm6L.js";import"./index.esm2017-T8jfeyBt.js";import{u as q}from"./react-redux-DItQxzwd.js";import{t as x}from"./Toasts-Cc5nLbJ6.js";import{B as y}from"./Button-DRBTarQj.js";import"./toasts-slice-DTwqLh1O.js";import"./redux-toolkit.modern-lSMJCofG.js";import"./v4-C6aID195.js";function Q(){const k=V(),r=H(),c=q(),g=O(),N=Y(),[P,X]=F(),[D,l]=o.useState(e.jsx(e.Fragment,{})),[p,f]=o.useState(""),j=o.useRef(),I=window.crypto.subtle||window.crypto.webkitSubtle;o.useEffect(()=>{const t=P.get("token");if(!t)console.log("no invite has been detected. please ask the game owner for another invite link."),l(e.jsxs("div",{children:[e.jsx("h1",{children:"No Invite Detected"}),e.jsx("h3",{children:"Please ask the game owner for another invite link."})]}));else{const[n,s,d]=t.split("."),a=JSON.parse(T(s)),i=a.iss,m=B.from(G(d),"base64"),v=L(`${n}.${s}`);b(u(r,`users/users/${i}/public/key`)).then(h=>{h.exists()&&S(h.val()).then(A=>{I.verify({name:"ECDSA",hash:"SHA-256"},A,m,v).then(C=>{if(!C)console.log("invalid invite"),l(e.jsxs("div",{children:[e.jsx("h1",{children:"Invalid Invite"}),e.jsx("h3",{children:"Please ask the game owner for another link."})]})),f("invalid");else{w(a);const $=setInterval(()=>{console.log("still in check expiration interval"),w(a)},5e3);j.current=$}})})})}},[]),o.useEffect(()=>()=>{console.log("CLEAR INTERVAL ON UNMOUNT"),clearInterval(j.current)},[c,N]);function S(t){return I.importKey("jwk",t,{name:"ECDSA",namedCurve:"P-256"},!0,["verify"])}function E(t){W(k,n=>{if(n){const s=n.uid,d="games/games/"+t.gameID;b(u(r,d)).then(a=>{const i=a.val();if(i.userID===s)c(x("Error","You're the owner of this game, you cannot be invited to it.")),setTimeout(()=>{g("/games")},3e3);else if(i.playersInGame&&s in i.playersInGame)c(x("Error","You're already in the game, you cannot be added again.")),setTimeout(()=>{g("/games")},3e3);else{const m=`gameInvites/${t.gameID}`;J(u(r),{[`${m}/invites/${t.jti}`]:null,[`${m}/numberOfGameInvites`]:M(-1),[`${d}/playersInGame`]:{[s]:n.displayName}}).catch(h=>{console.log("error deleting the game invitation from the db"),console.log(h.message)});const v=K(u(r,`users/users/${s}/public/joinedGames`));z(v,t.gameID),c(x("Success","You've been added to the game!")),setTimeout(()=>{g("/games")},3e3)}})}})}function w(t){t.exp<=Date.now()?(console.log("invite has expired"),p!=="expired"&&(l(e.jsxs("div",{children:[e.jsx("h1",{className:"lg:text-[3rem]",children:"Invite has expired"}),e.jsx("h3",{children:"Please ask the game owner for another link."})]})),f("expired"))):p!=="valid"&&(l(e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("h1",{children:["Invite to ",t.gameName]}),e.jsx("h3",{children:"Would you like to join?"})]}),e.jsxs("div",{className:"flex flex-row justify-around",children:[e.jsx(y,{onClick:()=>E(t),className:"w-[30%] bg-green-600 hover:bg-green-400",children:"Yes"}),e.jsx(U,{to:"/games",className:"w-[30%]",children:e.jsx(y,{className:"w-full",children:"No"})})]})]})),f("valid"))}return e.jsx(e.Fragment,{children:e.jsx("div",{className:"flex flex-col grow justify-center items-center text-center",children:e.jsx("div",{className:"w-[40vw] flex flex-col bg-white rounded-2xl px-15 py-20 gap-10",children:D})})})}const le=R(Q);async function de(){return{title:"Invite Page"}}export{de as clientLoader,le as default};
