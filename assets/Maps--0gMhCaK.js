import{a as g,t as e,B as E,v as P}from"./chunk-ZYFC6VSF-CcTFIW6Y.js";import{a as B}from"./react-redux-DItQxzwd.js";import{g as T}from"./index-35c79a8a-B373Vm6L.js";import"./index.esm2017-T8jfeyBt.js";import{g as A,u as M,r as y,i as C}from"./index.esm2017-BgJZ7Iac.js";import{g as q,r as z,d as G,u as $,a as H}from"./index.esm2017-Ck1t7IkA.js";import{B as x}from"./Button-DRBTarQj.js";import{S as V,I as W}from"./Selection-B6wnQ1jn.js";import{I as U}from"./Input-D8yPxS1O.js";import{v as X}from"./v4-C6aID195.js";function Y({cancelFn:D,submitFn:f}){const c=g.useRef(),[r,j]=g.useState(null),[b,w]=g.useState(50),[v,R]=g.useState(null);function N(t){t.preventDefault(),r!==null&&URL.revokeObjectURL(r);const i=t.target.files[0],s=new Image,m=URL.createObjectURL(i);j(m),s.src=m,s.onload=()=>{R(s);const d=c.current.getContext("2d");d.drawImage(s,0,0,700,500),d.save(),o(s,b)}}function o(t,i){const s=c.current.getContext("2d"),m=c.current.width,d=c.current.height,u=c.current.width/t.width,n=c.current.height/t.height,l=Math.min(u,n),h=(c.current.width-t.width*l)/2,p=(c.current.height-t.height*l)/2;s.clearRect(0,0,m,d),s.fillStyle="rgb(0 0 0 / 75%)",s.fillRect(0,0,m,d),s.drawImage(t,0,0,t.width,t.height,h,p,t.width*l,t.height*l),s.restore(),s.beginPath();for(let a=0;a<=m;a+=i)s.moveTo(a,0),s.lineTo(a,d);for(let a=0;a<=d;a+=i)s.moveTo(0,a),s.lineTo(m,a);s.strokeStyle="rgb(255 255 255 / 30%)",s.stroke(),s.closePath()}function I(t){const i=Number(t.target.value);w(i),o(v,i)}return e.jsxs(E,{onSubmit:f,children:[e.jsxs("div",{className:"flex flex-row justify-between items-center flex-wrap gap-y-3 mb-10",children:[e.jsx("h1",{children:"Map Creation"}),e.jsx(x,{type:"button",onClick:D,children:"Cancel"})]}),e.jsxs("div",{className:"w-full flex flex-col xl:flex-row xl:justify-around xl:items-center flex-wrap gap-15 xl:gap-x-[10vw]",children:[e.jsxs("div",{className:"flex flex-col items-start gap-3",children:[e.jsx("label",{htmlFor:"map-name",className:"text-black text-[2.5rem] font-[500] mr-10",children:"Map name"}),e.jsx(U,{id:"map-name",name:"map-name",type:"text",className:"text-[2rem]",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"map-image",className:"text-black text-[2.5rem] font-[500] mr-10",children:"Image"}),e.jsx(U,{id:"map-image",name:"map-image",type:"file",accept:"image/png, image/jpeg",onChange:t=>N(t),className:"text-[2rem] rounded-4xl file:bg-[#8E1616] file:text-white file:px-5 file:py-1 file:mr-5",required:!0})]}),r&&e.jsxs("div",{className:"max-w-full flex flex-col items-center gap-y-3 pb-3 overflow-x-auto",children:[e.jsx("canvas",{ref:c,id:"map-canvas",width:1e3,height:1e3,className:"w-fit h-fit mx-auto"}),e.jsxs("div",{children:[e.jsx("input",{type:"range",id:"map-cell-size",name:"map-cell-size",min:"25",max:"100",defaultValue:"50",onChange:t=>I(t)}),e.jsx("label",{htmlFor:"map-cell-size",className:"ml-5",children:`Cell size (${b})`})]})]}),e.jsxs("div",{className:"w-full",children:[e.jsx("p",{className:"text-[2.5rem] font-semibold text-black",children:"Notes"}),e.jsx("p",{children:"(Optional)"}),e.jsx("textarea",{id:"map-notes",name:"map-notes",className:"bg-white rounded-md text-[1.5rem] w-full h-50 p-1 mt-5"})]}),e.jsx(x,{type:"submit",className:"self-end xl:ml-auto",children:"Submit"})]})]})}const le=P(function(){const[f,c]=g.useState(!1),[r,j]=g.useState(),b=B(n=>n.maps.maps),w=A(),v=q(),N=T().currentUser;let o=null;N&&(o=N.uid);function I(){f||c(!0)}function t(){c(!1)}function i(n){f&&t(),r!==n&&j(n)}function s(n){n.target.localName!=="button"&&(f&&t(),j(void 0))}function m(n){j(void 0);const l="users/users/"+o+"/private";M(y(w),{["maps/maps/"+n]:null,"maps/numberOfMaps":C(-1),[l+"/maps/mapIDs/"+n]:null,[l+"/maps/numberOfMaps"]:C(-1)}).then(()=>{}).catch(p=>{console.log("error deleting map"),console.log(p.message)});const h=z(v,"users/"+o+"/maps/"+n);h&&G(h).then(()=>{}).catch(p=>{console.log("error deleting the map's image"),console.log(p.message)})}function d(n){n.preventDefault();const l=new FormData(n.target),h=Object.fromEntries(l),p=Math.floor(1e3/h["map-cell-size"]),a={image:h["map-image"],inGames:[],mapID:X(),name:h["map-name"],notes:h["map-notes"],size:{width:p,height:p},src:"",userID:o},k="users/users/"+o+"/private";if(M(y(w),{["maps/maps/"+a.mapID]:a,"maps/numberOfMaps":C(1),[k+"/maps/mapIDs/"+a.mapID]:a.name,[k+"/maps/numberOfMaps"]:C(1)}).then(()=>{}).catch(S=>{console.log("error writing the new map into the db"),console.log(S.message)}),a.image){const S=z(v,"users/"+o+"/maps/"+a.mapID);$(S,a.image).then(O=>{H(S).then(F=>{a.src=F,M(y(w),{["maps/maps/"+a.mapID]:a}).then(()=>{}).catch(L=>{console.log("error updating the map's src url in the db"),console.log(L.message)})})}).catch(O=>{console.log("error uploading map image"),console.log(O.message)})}t()}let u;return f?u=e.jsx(Y,{cancelFn:t,submitFn:d}):r==null?u=e.jsxs("div",{className:"h-[75vh] text-center content-center",children:[e.jsx("h2",{children:"A map hasn't been selected yet."}),e.jsx("p",{children:"Select a map or create a new one!"})]}):u=e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex flex-col text-center gap-15",children:[e.jsxs("div",{className:"flex flex-col text-center gap-5",children:[e.jsx("h1",{children:r.name}),r&&r.src&&e.jsx("img",{src:r.src,className:"self-center rounded-4xl max-w-full h-[40vh] object-contain"}),e.jsx("div",{className:"flex flex-row justify-between self-end",children:e.jsxs("div",{children:[e.jsx(x,{className:"mr-5",disabled:!0,children:"Expand Map"}),e.jsx(x,{onClick:()=>m(r.mapID),children:"Delete"})]})})]}),e.jsxs("div",{className:"flex flex-row text-start gap-20",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h3",{children:"Dimensions"}),e.jsxs("p",{children:[r.size.width," x ",r.size.height," (map tiles)"]})]}),e.jsxs("div",{className:"flex flex-col grow gap-2",children:[e.jsx("h3",{children:"Notes"}),e.jsx("div",{className:"bg-white rounded-xl p-3 whitespace-pre-wrap",children:r.notes})]})]}),e.jsxs("div",{className:"flex flex-row gap-20",children:[e.jsx("h3",{children:"Appears In"}),e.jsx("div",{className:"w-full bg-gray-400 p-3 rounded-sm text-gray-50",children:"Under construction"})]})]})}),e.jsxs("section",{id:"user-maps",className:"flex flex-row grow",children:[e.jsxs(V,{onClick:n=>s(n),children:[e.jsx(x,{onClick:I,children:"+ Create Map"}),e.jsx("ul",{className:"flex flex-col mt-10 gap-5",children:Object.entries(b).map(([n,l])=>l.src?e.jsx(x,{onClick:()=>i(l),imgSrc:l.src,children:l.name},l.name):e.jsx(x,{onClick:()=>i(l),children:l.name},l.name))})]}),e.jsx(W,{children:u})]})});async function re(){return{title:"Maps"}}export{re as clientLoader,le as default};
